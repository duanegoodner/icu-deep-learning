[preprocess]
min_age = 18
min_los_hospital = 1
min_los_icu = 1
bg_data_cols = [
    "potassium", "calcium", "ph", "pco2", "lactate"
]
lab_data_cols = [
    "albumin",
    "bun",
    "creatinine",
    "sodium",
    "bicarbonate",
    "platelet",
    "glucose",
    "magnesium"
]
vital_data_cols = [
    "heartrate",
    "sysbp",
    "diasbp",
    "tempc",
    "resprate",
    "spo2"
]
winsorize_low = "5%"
winsorize_high = "95%"
resample_interpolation_method = "linear"
resample_limit_direction = "both"
min_observation_hours = 48
observation_window_hours = 48
observation_window_start = "intime"

[preprocess.output_dir_names]
prefilter = "1_prefilter"
measurement_merger = "2_merged_stay_measurements"
admission_list_builder = "3_full_admission_list"
feature_builder = "4_feature_builder"
feature_finalizer = "5_feature_finalizer"


[model]
trainer_eval_general_logging_metrics = [
    "accuracy",
    "auc",
    "f1",
    "precision",
    "recall",
    "validation_loss",
]
trainer_eval_tensorboard_metrics = [
#    "accuracy",
    "auc",
    "f1",
    "precision",
    "recall",
    "validation_loss",
]

[model.trainer]
random_seed = 12345678

[model.tuner_driver]
num_trials = 30
num_folds = 3
num_cv_epochs = 2
epochs_per_fold = 2
kfold_random_seed = 1234
cv_mean_tensorboard_metrics = [
    "accuracy",
    "auc",
    "f1",
    "precision",
    "recall",
    "validation_loss"]
performance_metric = "validation_loss"
optimization_direction_label = "minimize"
tuning_output_dir = "data/model/tuning"
pruner_name = "MedianPruner"
sampler_name = "TPESampler"
db_env_var_name = "MODEL_TUNING_DB_NAME"
fold_class_name = "StratifiedKFold"
collate_fn_name = "x19m_collate_fn"

[model.tuner_driver.tuning_ranges]
log_lstm_hidden_size = [5, 7]
lstm_act_options = ["ReLU", "Tanh"]
dropout = [0.0, 0.5]
log_fc_hidden_size = [4, 8]
fc_act_options = ["ReLU", "Tanh"]
optimizer_options = ["Adam", "RMSprop", "SGD"]
learning_rate = [0.00001, 0.1]
log_batch_size = [5, 8]

[model.tuner_driver.pruner_kwargs]
n_startup_trials = 5
n_warmup_steps = 3

[model.tuner_driver.sampler_kwargs]

[model.cv_driver_settings]
kfold_random_seed = 86420
epochs_per_fold = 20
num_folds = 5
eval_interval = 10
single_fold_eval_fraction = 0.2
fold_class_name = "StratifiedKFold"
collate_fn_name = "x19m_collate_fn"

[model.attr_display_labels]
accuracy = "accuracy"
auc = "AUC"
f1 = "F1"
precision = "precison"
recall = "recall"
validation_loss = "_validation_loss"


[attack.tuning]
kappa = [0.0, 2.0]
lambda_1 = [1e-7, 1.0]
optimizer_options = ["Adam", "RMSprop", "SGD"]
learning_rate = [1e-5, 1.0]
log_batch_size = [5, 7]

[attack.tuner_driver_settings]
db_env_var_name = "ATTACK_TUNING_DB_NAME"
num_trials = 75
epochs_per_batch = 1000
max_num_samples = 520
sample_selection_seed = 2023
pruner_name = "MedianPruner"
sampler_name = "TPESampler"
objective_name = "sparse_small_max"
max_perts = 2    # used when objective_name = "max_num_nonzero_perts"
attack_misclassified_samples = false

[attack.tuner_driver_settings.objective_extra_kwargs]

[attack.tuner_driver_settings.pruner_kwargs]

[attack.tuner_driver_settings.sampler_kwargs]

[attack.driver_settings] # As starting point, match values in attack.tuner_driver_settings
epochs_per_batch = 1000
max_num_samples = 520
sample_selection_seed = 2023
attack_misclassified_samples = false

[attack.analysis]
default_seq_length = 48


[paths]
root_pkg = "src/lstm_adversarial_attack"
output_data = "data"
docker = "docker"

[paths.sub_packages]
db = "root_pkg::query_db"
preprocess = "root_pkg::preprocess"

[paths.db]
mimiciii_dotenv = "sub_packages.db::mimiciii_database.env"
queries_dir = "sub_packages.db::mimiciii_queries"
query_files = [
    "db.queries_dir::icustay_detail.sql",
    "db.queries_dir::pivoted_bg.sql",
    "db.queries_dir::pivoted_lab.sql",
    "db.queries_dir::pivoted_vital.sql"
]
output_root = "output_data::query_db"


[paths.preprocess]
output_root = "output_data::preprocess"

[preprocess.prefilter.resources.from_db]
icustay = "icustay_detail.csv"
bg = "pivoted_bg.csv"
lab = "pivoted_lab.csv"
vital = "pivoted_vital.csv"

[preprocess.measurement_merger.resources.from_other_preprocess_modules]
prefiltered_icustay = "1_prefilter/prefiltered_icustay.feather"
prefiltered_bg = "1_prefilter/prefiltered_bg.feather"
prefiltered_lab = "1_prefilter/prefiltered_lab.feather"
prefiltered_vital = "1_prefilter/prefiltered_vital.feather"

[preprocess.admission_list_builder.resources.from_other_preprocess_modules]
icustay_bg_lab_vital = "2_merged_stay_measurements/icustay_bg_lab_vital.feather"

[preprocess.feature_builder.resources.from_other_preprocess_modules]
bg_lab_vital_summary_stats = "2_merged_stay_measurements/bg_lab_vital_summary_stats.feather"
full_admission_list = "3_full_admission_list/full_admission_list.json"

[preprocess.feature_finalizer.resources.from_other_preprocess_modules]
processed_admission_list = "4_feature_builder/processed_admission_list.json"

[dataset.resources.measurement_data_list]
preprocess = "5_feature_finalizer/measurement_data_list.json"

[dataset.resources.in_hospital_mortality_list]
preprocess = "5_feature_finalizer/in_hospital_mortality_list.json"

[dataset.resources.measurement_col_names]
preprocess = "5_feature_finalizer/measurement_col_names.json"

[paths.model.tuner_driver]
output_dir = "output_data::model/tuning"

[paths.model.cv_driver]
output_dir = "output_data::model/cross_validation"

[paths.attack.tune]
output_dir = "output_data::attack/tuning"

[paths.attack.tuner_driver]
output_dir = "output_data::attack/tuning"

[paths.attack.attack_driver]
output_dir = "output_data::attack/frozen_hyperparameter_attack"

[paths.attack_analysis]
output_dir = "output_data::attack_analysis"
